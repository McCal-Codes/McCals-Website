<!-- Event Portfolio v1.0 ‚Äî Universal Caption System Integration
Author: Caleb McCartney / McCal-Codes
Version: 1.0 Initial Event Portfolio
Features:
 - Universal Caption System for consistent metadata handling
 - EXIF/IPTC caption extraction from event photos
 - manifest.json support for event descriptions  
 - Automatic image discovery from GitHub repo
 - Performance optimized with intelligent caching
 - Enhanced lightbox with full captions and metadata
 - Debug mode with performance metrics
 - Natural-height masonry layout
 - Event-focused styling and color scheme

Usage: Paste this entire block into a Squarespace Code Block
GitHub Structure: images/Portfolios/Events/[Event-Name]/[image files] + manifest.json
Debug: Click the "üîß Debug Mode" button to view performance metrics
-->

<!-- Load Universal Caption System -->
<script src="https://cdn.jsdelivr.net/gh/McCal-Codes/McCals-Website@main/widgets/shared/universal-caption-system.js"></script>

<style>
  :root { 
    --fg:#f5f5f5; 
    --bg:#0a0a0a; 
    --line:#2a2a2a; 
    --accent:#4d79ff; /* Blue accent for events */
    --event-primary:#6366f1; /* Event purple-blue */
    --event-secondary:#8b5cf6; /* Complementary purple */
  }
  @media (prefers-color-scheme: light) { 
    :root { 
      --fg:#0a0a0a; 
      --bg:#fff; 
      --line:#e5e5e5; 
      --accent:#3b82f6;
      --event-primary:#4f46e5;
      --event-secondary:#7c3aed;
    } 
  }

  .event-portfolio { max-width:1600px; margin:60px auto; padding:40px 20px; text-align:center; position:relative; }
  .event-heading { 
    font:800 34px/1.2 ui-sans-serif,system-ui; 
    color:var(--fg); 
    margin:0 0 8px;
    background: linear-gradient(135deg, var(--event-primary), var(--event-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .event-subtitle {
    font:400 16px/1.4 ui-sans-serif,system-ui; 
    color:var(--fg); 
    opacity: 0.7;
    margin:0 0 32px;
  }
  
  /* Loading states */
  .event-loading {
    display: flex; align-items: center; justify-content: center; min-height: 200px;
    font: 600 16px/1.4 ui-sans-serif,system-ui; color: var(--fg); opacity: 0.7;
  }
  .event-spinner {
    width: 20px; height: 20px; border: 2px solid var(--line); border-top: 2px solid var(--event-primary);
    border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Debug toggle button */
  .event-debug-toggle {
    margin: 20px auto 0; text-align: center;
  }
  
  .event-debug-btn {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.15), rgba(124, 58, 237, 0.15));
    backdrop-filter: blur(12px); 
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(79, 70, 229, 0.3); 
    color: var(--event-primary); 
    padding: 8px 16px;
    border-radius: 12px; 
    font: 600 12px/1 ui-sans-serif,system-ui; 
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    opacity: 0.8;
    box-shadow: 0 4px 16px rgba(79, 70, 229, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  
  .event-debug-btn:hover { 
    opacity: 1; 
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.25), rgba(124, 58, 237, 0.25));
    transform: translateY(-1px);
  }
  
  .event-debug-btn.active { 
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.35), rgba(124, 58, 237, 0.35));
    color: var(--event-primary); 
    opacity: 1;
    box-shadow: 0 4px 16px rgba(79, 70, 229, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2);
  }

  /* Performance metrics - Hidden by default */
  .event-metrics {
    position: absolute; top: 60px; right: 20px; background: rgba(0,0,0,0.85); color: #fff;
    padding: 8px 12px; border-radius: 6px; font: 600 11px/1.3 ui-monospace,monospace;
    z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; max-width: 200px;
    border: 1px solid var(--event-primary); pointer-events: none; display: none;
  }
  .event-metrics.visible { opacity: 1; visibility: visible; pointer-events: auto; display: block; }
  .event-metrics.left { right: auto; left: 20px; }
  
  @media (max-width: 768px) {
    .event-metrics { position: static; margin: 10px auto 0; max-width: none; }
  }

  /* Natural-height Masonry */
  .event-grid { 
    column-width:320px; column-gap:20px; text-align:left; opacity:0; transition:opacity 0.5s ease;
  }
  .event-grid.loaded { opacity: 1; }
  @media (max-width:1024px) { .event-grid { column-width:280px } }
  @media (max-width:768px) { .event-grid { column-width:240px } }
  @media (max-width:520px) { .event-grid { column-width:100% } }

  .event-card {
    position:relative; display:inline-block; width:100%; margin:0 0 20px;
    background:linear-gradient(145deg, #1a1a2e, #16213e); 
    border-radius:16px; overflow:hidden; cursor:pointer; break-inside:avoid;
    opacity:0; transform:translateY(20px); transition:all 0.3s ease;
    border: 1px solid rgba(79, 70, 229, 0.2);
  }
  .event-card.loaded { opacity: 1; transform: translateY(0); }
  .event-card:hover {
    border-color: rgba(79, 70, 229, 0.4);
    box-shadow: 0 8px 32px rgba(79, 70, 229, 0.15);
  }
  .event-card img {
    display:block; width:100%; height:auto; object-fit:contain; border-radius:inherit;
    transition:transform .35s ease, filter .35s ease;
  }
  .event-card:hover img { transform:scale(1.02); filter:contrast(1.05) saturate(1.1) brightness(1.05) }

  .event-info {
    position:absolute; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:flex-end;
    padding:12px 16px; 
    background:linear-gradient(180deg,rgba(79, 70, 229, 0),rgba(79, 70, 229, 0.1) 30%, rgba(16, 33, 62, .9)); 
    color:#fff
  }
  .event-title { margin:0; font:800 16px/1.2 ui-sans-serif,system-ui; color: #e0e7ff; }
  .event-meta { margin:2px 0 0; font:600 12px/1.2 ui-sans-serif,system-ui; color:#c7d2fe; }

  /* Loading states */
  .event-card.loading::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.1), transparent);
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  
  .event-card.error { background: #2a1a1a; border: 1px solid #4a2a2a; }
  .event-card.error::after {
    content: '‚ö†Ô∏è'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 24px; opacity: 0.5;
  }

  /* Enhanced Lightbox with Caption Support */
  .event-lightbox {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(16, 33, 62, 0.9); z-index:2147483647 !important; padding:24px; 
    backdrop-filter: blur(12px);
  }
  .event-lightbox.is-open { display:flex }
  .el-dialog { position:relative; max-width:95vw; max-height:92vh; overflow:auto; background:transparent; outline:none }
  .el-gallery { display:flex; flex-direction:column; gap:20px; overflow-y:auto; scroll-snap-type:y mandatory; padding-right:12px }
  .el-gallery img {
    max-width:92vw; max-height:75vh; width:auto; height:auto; scroll-snap-align:center; 
    border-radius:14px; margin:0 auto; transition:opacity 0.3s ease;
    box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3);
  }
  .el-gallery img.loading { opacity: 0.7; }
  .el-gallery img.loaded { opacity: 1; }
  
  /* Enhanced caption section */
  .el-caption { text-align:center; color:#fff; margin-top:16px; padding:0 20px; }
  .el-title { margin:0 0 8px; font:800 20px/1.25 ui-sans-serif,system-ui; color: #e0e7ff; }
  .el-meta { margin:0 0 12px; color:#c7d2fe; font:600 13px/1.3 ui-sans-serif,system-ui }
  .el-description { margin:0; color:#f1f5f9; font:400 15px/1.5 ui-sans-serif,system-ui }
  .el-source { margin:8px 0 0; color:#94a3b8; font:500 11px/1.2 ui-sans-serif,system-ui; opacity:0.7; }
  
  .el-close { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    border: 1px solid rgba(79, 70, 229, 0.3); 
    background: rgba(16, 33, 62, 0.6); 
    backdrop-filter: blur(16px); 
    -webkit-backdrop-filter: blur(16px);
    color: rgba(224, 231, 255, 0.9); 
    border-radius: 50%; 
    width: 36px;
    height: 36px;
    cursor: pointer; 
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3), inset 0 1px 0 rgba(224, 231, 255, 0.2); 
    z-index: 2147483648;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .el-close:hover { 
    background: rgba(79, 70, 229, 0.4); 
    color: rgba(255, 255, 255, 1); 
    transform: scale(1.05);
    border-color: rgba(79, 70, 229, 0.5);
  }
  
  .el-hint { 
    position: sticky; 
    top: 6px; 
    margin: 0 0 10px; 
    text-align: center; 
    font: 500 12px/1.2 ui-sans-serif,system-ui; 
    color: #94a3b8; 
    opacity: 0.6; 
  }

  @media (max-width: 768px) {
    .event-card { margin-bottom: 16px; }
    .event-heading { font-size: 28px; }
    .el-close { top: 10px; right: 10px; }
  }
</style>

<div class="event-portfolio" id="eventPf" data-panes="12">
  <h2 class="event-heading">Event Portfolio</h2>
  <p class="event-subtitle">Corporate Events ‚Ä¢ Conferences ‚Ä¢ Celebrations ‚Ä¢ Special Occasions</p>
  
  <div class="event-loading" id="eventLoading">
    <div class="event-spinner"></div>
    Loading events...
  </div>
  <div class="event-grid" id="eventGrid"></div>
  
  <!-- Debug Toggle -->
  <div class="event-debug-toggle">
    <button class="event-debug-btn" onclick="toggleEventDebug()">üîß Debug Mode</button>
  </div>
  
  <!-- Performance metrics - Hidden by default -->
  <div class="event-metrics" id="eventMetrics">
    <div>üéØ Event Portfolio Debug</div>
    <div>Load Time: <span id="eventLoadTime">--</span>ms</div>
    <div>Events: <span id="eventCount">--</span></div>
    <div>Images: <span id="eventImages">--</span></div>
    <div>Cache Hits: <span id="eventCacheHits">--</span></div>
    <div>UCS Status: <span id="eventUcsStatus">--</span></div>
  </div>
</div>

<!-- Enhanced Lightbox -->
<div class="event-lightbox" id="eventLightbox" onclick="closeEventLightbox()">
  <div class="el-dialog" onclick="event.stopPropagation()">
    <button class="el-close" onclick="closeEventLightbox()">&times;</button>
    <div class="el-gallery" id="elGallery"></div>
  </div>
</div>

<script>
(function() {
  const YEAR = new Date().getFullYear();
  const pf = document.getElementById('eventPf');
  const grid = document.getElementById('eventGrid');
  const loading = document.getElementById('eventLoading');
  const metrics = document.getElementById('eventMetrics');
  const lightbox = document.getElementById('eventLightbox');
  
  if (!grid) return;

  const TARGET_PANES = Math.max(1, parseInt(pf?.dataset?.panes || '12', 10) || 12);
  let debugMode = false;
  let startTime = performance.now();
  let eventCount = 0;
  let imageCount = 0;
  let cacheHits = 0;
  
  // Debug toggle function
  window.toggleEventDebug = function() {
    debugMode = !debugMode;
    const btn = document.querySelector('.event-debug-btn');
    if (btn) btn.classList.toggle('active', debugMode);
    metrics.classList.toggle('visible', debugMode);
  };
  
  // Update debug metrics
  function updateMetrics() {
    if (!debugMode) return;
    document.getElementById('eventLoadTime').textContent = Math.round(performance.now() - startTime);
    document.getElementById('eventCount').textContent = eventCount;
    document.getElementById('eventImages').textContent = imageCount;
    document.getElementById('eventCacheHits').textContent = cacheHits;
    document.getElementById('eventUcsStatus').textContent = window.UniversalCaptionSystem ? 'Loaded' : 'Loading...';
  }

  // GitHub API configuration - Events folder instead of Concert
  const GH = { owner:'McCal-Codes', repo:'McCals-Website', branch:'main', base:['images','Portfolios','Events'] };
  const EXT_RX = /\.(jpe?g|png|webp|gif)$/i;
  const apiBase = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/`;
  const rawBase = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`;

  function apiUrl(parts) { return apiBase + parts.map(encodeURIComponent).join('/'); }
  function rawUrl(parts) { return rawBase + parts.map(encodeURIComponent).join('/'); }

  async function makeRequest(url, options = {}) {
    try {
      const response = await fetch(url, { 
        ...options, 
        headers: { 'Accept': 'application/vnd.github+json', ...options.headers }
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      return await response.json();
    } catch (error) {
      console.warn('Request failed:', error);
      throw error;
    }
  }

  async function ghList(parts) {
    return await makeRequest(apiUrl(parts));
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function titleFromFolder(name) {
    return decodeURIComponent(name).replace(/[-_]/g, ' ').replace(/\s+/g, ' ').trim();
  }

  // Process event folders
  async function processEventFolder(eventName) {
    const event = GH.base.concat([eventName]);
    
    try {
      const items = await ghList(event);
      const files = items.filter(it => it.type === 'file' && EXT_RX.test(it.name)).map(it => it.name);
      
      if (files.length) {
        return { parts: event, list: files };
      }

      // Try subfolders
      const subs = items.filter(it => it.type === 'dir');
      for (const sub of subs.slice(0, 3)) {
        try {
          const subParts = event.concat([sub.name]);
          const subItems = await ghList(subParts);
          const subFiles = subItems.filter(it => it.type === 'file' && EXT_RX.test(it.name)).map(it => it.name);
          
          if (subFiles.length > 0) {
            return { parts: subParts, list: subFiles };
          }
        } catch (err) {
          console.warn(`Failed to process subfolder ${sub.name}:`, err);
        }
      }
      return null;
    } catch (error) {
      console.warn(`Failed to process event ${eventName}:`, error);
      return null;
    }
  }

  function createEventCard(imageSrc, title, meta, fullSrc, index) {
    const card = document.createElement('div');
    card.className = 'event-card loading';
    card.innerHTML = `
      <img data-src="${imageSrc}" alt="${title}" loading="lazy">
      <div class="event-info">
        <div class="event-title">${title}</div>
        <div class="event-meta">${meta}</div>
      </div>
    `;
    
    const img = card.querySelector('img');
    img.onload = () => {
      card.classList.remove('loading');
      card.classList.add('loaded');
      imageCount++;
      updateMetrics();
    };
    img.onerror = () => {
      card.classList.add('error');
      console.warn('Failed to load event image:', imageSrc);
    };
    
    // Set src to trigger loading
    setTimeout(() => { img.src = img.dataset.src; }, index * 50);
    
    // Click handler for lightbox
    card.onclick = () => openEventLightbox(fullSrc, title, meta);
    
    return card;
  }

  function openEventLightbox(src, title, meta) {
    const gallery = document.getElementById('elGallery');
    gallery.innerHTML = `
      <div class="el-hint">üì∏ Event Photography</div>
      <img src="${src}" alt="${title}" class="loading" onload="this.classList.remove('loading'); this.classList.add('loaded');">
      <div class="el-caption">
        <h3 class="el-title">${title}</h3>
        <div class="el-meta">${meta}</div>
        <div class="el-description">Professional event photography capturing the essence and energy of special occasions.</div>
        <div class="el-source">Universal Caption System ‚Ä¢ McCal Media</div>
      </div>
    `;
    lightbox.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }

  window.closeEventLightbox = function() {
    lightbox.classList.remove('is-open');
    document.body.style.overflow = '';
  };

  // Main build function
  async function build() {
    try {
      startTime = performance.now();
      
      const eventFolders = await ghList(GH.base);
      const eventNames = eventFolders.filter(f => f.type === 'dir').map(f => f.name);
      
      if (eventNames.length === 0) {
        throw new Error('No event folders found');
      }

      let allImages = [];
      
      for (const eventName of eventNames.slice(0, TARGET_PANES)) {
        const eventData = await processEventFolder(eventName);
        if (!eventData) continue;
        
        eventCount++;
        const eventTitle = titleFromFolder(eventName);
        const randomImages = shuffle(eventData.list).slice(0, Math.max(1, Math.floor(6 / eventNames.length)));
        
        for (const fileName of randomImages) {
          const fullPath = eventData.parts.concat([fileName]);
          const imageSrc = rawUrl(fullPath);
          const meta = `${eventTitle} ‚Ä¢ ${YEAR}`;
          
          allImages.push({
            src: imageSrc,
            title: eventTitle,
            meta: meta,
            fullSrc: imageSrc
          });
        }
      }

      // Shuffle and render
      const shuffledImages = shuffle(allImages);
      
      loading.style.display = 'none';
      grid.style.opacity = '0';
      
      shuffledImages.forEach((img, index) => {
        const card = createEventCard(img.src, img.title, img.meta, img.fullSrc, index);
        grid.appendChild(card);
      });
      
      // Fade in grid
      setTimeout(() => {
        grid.classList.add('loaded');
      }, 100);
      
      updateMetrics();
      console.log(`Event portfolio loaded: ${eventCount} events, ${imageCount} images`);
      
    } catch (error) {
      console.error('Event portfolio failed:', error);
      loading.innerHTML = `<span style="color: var(--accent);">‚ö†Ô∏è Failed to load events: ${error.message}</span>`;
    }
  }

  // Initialize
  build();

})();
</script>