<!-- Concert Portfolio v3.0 ‚Äî Universal Caption System Integration
Author: Caleb McCartney / McCal-Codes
Version: 3.0 Universal Caption System Integration
Features:
 - Universal Caption System for consistent metadata handling
 - EXIF/IPTC caption extraction from concert photos
 - manifest.json support for band/show descriptions  
 - Automatic image discovery from GitHub repo
 - Performance optimized with intelligent caching
 - Enhanced lightbox with full captions and metadata
 - Debug mode with performance metrics
 - Natural-height masonry layout

Usage: Paste this entire block into a Squarespace Code Block
GitHub Structure: images/Portfolios/Concert/[Band-Name]/[image files] + manifest.json
Debug: Click the "üîß Debug Mode" button to view performance metrics
-->

<!-- Load Universal Caption System -->
<script src="https://cdn.jsdelivr.net/gh/McCal-Codes/McCals-Website@main/widgets/shared/universal-caption-system.js"></script>

<style>
  :root { --fg:#f5f5f5; --bg:#0a0a0a; --line:#2a2a2a; --accent:#ff4d6d; }
  @media (prefers-color-scheme: light) { :root { --fg:#0a0a0a; --bg:#fff; --line:#e5e5e5; } }

  .concert-portfolio { max-width:1600px; margin:60px auto; padding:40px 20px; text-align:center; position:relative; }
  .concert-heading { font:800 34px/1.2 ui-sans-serif,system-ui; color:var(--fg); margin:0 0 18px }
  
  /* Loading states */
  .concert-loading {
    display: flex; align-items: center; justify-content: center; min-height: 200px;
    font: 600 16px/1.4 ui-sans-serif,system-ui; color: var(--fg); opacity: 0.7;
  }
  .concert-spinner {
    width: 20px; height: 20px; border: 2px solid var(--line); border-top: 2px solid var(--accent);
    border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* Debug toggle button */
  .concert-debug-toggle {
    margin: 20px auto 0; text-align: center;
  }
  
  .concert-debug-btn {
    background: rgba(0, 0, 0, 0.1); 
    backdrop-filter: blur(12px); 
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1); 
    color: rgba(255, 255, 255, 0.8); 
    padding: 8px 16px;
    border-radius: 12px; 
    font: 600 12px/1 ui-sans-serif,system-ui; 
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    opacity: 0.7;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
  
  .concert-debug-btn:hover { 
    opacity: 1; 
    background: rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
  }
  
  .concert-debug-btn.active { 
    background: rgba(0, 0, 0, 0.3); 
    color: rgba(255, 255, 255, 1); 
    opacity: 1;
  }
  
  @media (prefers-color-scheme: light) {
    .concert-debug-btn {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.8);
    }
    
    .concert-debug-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      color: rgba(0, 0, 0, 0.95);
    }
    
    .concert-debug-btn.active {
      background: rgba(255, 255, 255, 0.35);
      color: rgba(0, 0, 0, 1);
    }
  }

  /* Performance metrics - Hidden by default */
  .concert-metrics {
    position: absolute; top: 60px; right: 20px; background: rgba(0,0,0,0.85); color: #fff;
    padding: 8px 12px; border-radius: 6px; font: 600 11px/1.3 ui-monospace,monospace;
    z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; max-width: 200px;
    border: 1px solid var(--line); pointer-events: none; display: none;
  }
  .concert-metrics.visible { opacity: 1; visibility: visible; pointer-events: auto; display: block; }
  .concert-metrics.left { right: auto; left: 20px; }
  
  @media (max-width: 768px) {
    .concert-metrics { position: static; margin: 10px auto 0; max-width: none; }
  }

  /* Natural-height Masonry */
  .concert-grid { 
    column-width:320px; column-gap:20px; text-align:left; opacity:0; transition:opacity 0.5s ease;
  }
  .concert-grid.loaded { opacity: 1; }
  @media (max-width:1024px) { .concert-grid { column-width:280px } }
  @media (max-width:768px) { .concert-grid { column-width:240px } }
  @media (max-width:520px) { .concert-grid { column-width:100% } }

  .concert-card {
    position:relative; display:inline-block; width:100%; margin:0 0 20px;
    background:#111; border-radius:16px; overflow:hidden; cursor:pointer; break-inside:avoid;
    opacity:0; transform:translateY(20px); transition:all 0.3s ease;
  }
  .concert-card.loaded { opacity: 1; transform: translateY(0); }
  .concert-card img {
    display:block; width:100%; height:auto; object-fit:contain; border-radius:inherit;
    transition:transform .35s ease, filter .35s ease;
  }
  .concert-card:hover img { transform:scale(1.02); filter:contrast(1.08) saturate(1.08) }

  .concert-info {
    position:absolute; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:flex-end;
    padding:10px 14px; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.85)); color:#fff
  }
  .concert-title { margin:0; font:800 16px/1.2 ui-sans-serif,system-ui }
  .concert-meta { margin:2px 0 0; font:600 12px/1.2 ui-sans-serif,system-ui; color:#e5e5e5 }

  /* Loading states */
  .concert-card.loading::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 1.5s infinite;
  }
  @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  
  .concert-card.error { background: #2a1a1a; border: 1px solid #4a2a2a; }
  .concert-card.error::after {
    content: '‚ö†Ô∏è'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 24px; opacity: 0.5;
  }

  /* Enhanced Lightbox with Caption Support */
  .concert-lightbox {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.9); z-index:2147483647 !important; padding:24px; backdrop-filter: blur(8px);
  }
  .concert-lightbox.is-open { display:flex }
  .cl-dialog { position:relative; max-width:95vw; max-height:92vh; overflow:auto; background:transparent; outline:none }
  .cl-gallery { display:flex; flex-direction:column; gap:20px; overflow-y:auto; scroll-snap-type:y mandatory; padding-right:12px }
  .cl-gallery img {
    max-width:92vw; max-height:75vh; width:auto; height:auto; scroll-snap-align:center; 
    border-radius:14px; margin:0 auto; transition:opacity 0.3s ease;
  }
  .cl-gallery img.loading { opacity: 0.7; }
  .cl-gallery img.loaded { opacity: 1; }
  
  /* Enhanced caption section */
  .cl-caption { text-align:center; color:#fff; margin-top:16px; padding:0 20px; }
  .cl-title { margin:0 0 8px; font:800 20px/1.25 ui-sans-serif,system-ui }
  .cl-meta { margin:0 0 12px; color:#cfcfcf; font:600 13px/1.3 ui-sans-serif,system-ui }
  .cl-description { margin:0; color:#f5f5f5; font:400 15px/1.5 ui-sans-serif,system-ui }
  .cl-source { margin:8px 0 0; color:#888; font:500 11px/1.2 ui-sans-serif,system-ui; opacity:0.7; }
  
  .cl-close { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    border: 1px solid rgba(255, 255, 255, 0.2); 
    background: rgba(0, 0, 0, 0.4); 
    backdrop-filter: blur(16px); 
    -webkit-backdrop-filter: blur(16px);
    color: rgba(255, 255, 255, 0.9); 
    border-radius: 50%; 
    width: 36px;
    height: 36px;
    cursor: pointer; 
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2); 
    z-index: 2147483648;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .cl-close:hover { 
    background: rgba(0, 0, 0, 0.6); 
    color: rgba(255, 255, 255, 1); 
    transform: scale(1.05);
    border-color: rgba(255, 255, 255, 0.3);
  }
  
  .cl-hint { 
    position: sticky; 
    top: 6px; 
    align-self: center; 
    background: rgba(0, 0, 0, 0.3); 
    backdrop-filter: blur(12px); 
    color: rgba(255, 255, 255, 0.9); 
    padding: 6px 12px; 
    border-radius: 20px; 
    font: 600 12px/1 ui-sans-serif,system-ui; 
    transition: opacity 0.4s ease;
  }
  .cl-hint.fade { opacity:0 }

  /* Header overlay prevention */
  html.lb-open header,html.lb-open .Header,html.lb-open [id*="Header"],html.lb-open .site-header,html.lb-open .sqs-announcement-bar { pointer-events:none; }
</style>

<div class="concert-portfolio" id="concertPf" data-panes="12">
  <h2 class="concert-heading">Concert Portfolio</h2>
  <div class="concert-loading" id="concertLoading">
    <div class="concert-spinner"></div>
    Loading concerts...
  </div>
  <div class="concert-grid" id="concertGrid"></div>
  
  <!-- Debug toggle button -->
  <div class="concert-debug-toggle">
    <button class="concert-debug-btn" id="debugToggle" title="Toggle performance metrics">
      üîß Debug Mode
    </button>
  </div>
</div>

<!-- Performance metrics -->
<div class="concert-metrics" id="concertMetrics"></div>

<div class="concert-lightbox" id="concertLightbox" aria-hidden="true">
  <div class="cl-dialog" role="dialog" aria-modal="true" aria-labelledby="clLbTitle" tabindex="-1">
    <button class="cl-close" type="button" aria-label="Close">√ó</button>
    <div class="cl-gallery" id="clGallery">
      <div class="cl-hint">Scroll ‚Üì</div>
    </div>
    <div class="cl-caption">
      <h3 class="cl-title" id="clLbTitle"></h3>
      <p class="cl-meta" id="clLbMeta"></p>
      <p class="cl-description" id="clLbDescription"></p>
      <p class="cl-source" id="clLbSource"></p>
    </div>
  </div>
</div>

<script>
(function() {
  const YEAR = new Date().getFullYear();
  const pf = document.getElementById('concertPf');
  const grid = document.getElementById('concertGrid');
  const loading = document.getElementById('concertLoading');
  const metrics = document.getElementById('concertMetrics');
  
  if (!grid) return;

  const TARGET_PANES = Math.max(1, parseInt(pf?.dataset?.panes || '12', 10) || 12);
  
  // Debug mode state management
  let DEBUG_MODE = localStorage.getItem('concert-debug') === 'true';
  const debugToggle = document.getElementById('debugToggle');
  
  function updateDebugButton() {
    if (debugToggle) {
      debugToggle.classList.toggle('active', DEBUG_MODE);
      debugToggle.textContent = DEBUG_MODE ? 'üîß Debug ON' : 'üîß Debug Mode';
    }
  }
  
  updateDebugButton();

  // Performance metrics
  let performanceMetrics = { requests: 0, cacheHits: 0, cacheMisses: 0, errors: 0, avgResponseTime: 0 };

  // GitHub API configuration
  const GH = { owner:'McCal-Codes', repo:'McCals-Website', branch:'main', base:['images','Portfolios','Concert'] };
  const EXT_RX = /\.(jpe?g|png|webp|gif)$/i;
  const apiBase = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/`;
  const rawBase = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`;

  function apiUrl(parts) { return apiBase + parts.map(encodeURIComponent).join('/'); }
  function rawUrl(parts) { return rawBase + parts.map(encodeURIComponent).join('/'); }

  // Cache system
  const cache = new Map();
  function getCached(key) {
    const entry = cache.get(key);
    if (!entry) return null;
    if (Date.now() > entry.expires) { cache.delete(key); return null; }
    return entry.data;
  }
  function setCache(key, data, ttl = 10 * 60 * 1000) {
    cache.set(key, { data, expires: Date.now() + ttl });
  }

  // Enhanced HTTP requests
  async function makeRequest(url, options = {}) {
    const startTime = performance.now();
    performanceMetrics.requests++;
    
    try {
      const response = await fetch(url, { 
        ...options, 
        headers: { 'Accept': 'application/vnd.github+json', ...options.headers }
      });
      
      const duration = performance.now() - startTime;
      performanceMetrics.avgResponseTime = (performanceMetrics.avgResponseTime + duration) / 2;
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (error) {
      performanceMetrics.errors++;
      throw error;
    }
  }

  async function ghList(parts) {
    const cacheKey = `list:${parts.join('/')}`;
    const cached = getCached(cacheKey);
    if (cached) {
      performanceMetrics.cacheHits++;
      return cached;
    }
    
    performanceMetrics.cacheMisses++;
    const result = await makeRequest(apiUrl(parts));
    setCache(cacheKey, result);
    return result;
  }

  // Load manifest for a band
  async function loadBandManifest(bandPath) {
    try {
      const manifestUrl = rawUrl(bandPath.concat(['manifest.json']));
      return await window.UniversalCaptionSystem.loadManifest(manifestUrl);
    } catch (error) {
      return null;
    }
  }

  // Process band albums
  async function processBandAlbum(bandName) {
    const band = GH.base.concat([bandName]);
    
    try {
      // Load band manifest for custom metadata
      const manifest = await loadBandManifest(band);
      
      // Try manifest first
      if (manifest && (Array.isArray(manifest) || manifest.images)) {
        const images = Array.isArray(manifest) ? manifest : manifest.images;
        if (images && images.length > 0) {
          const imageFiles = images.filter(n => EXT_RX.test(n));
          if (imageFiles.length > 0) {
            return {
              parts: band,
              list: imageFiles,
              manifest: manifest,
              bandData: typeof manifest === 'object' && !Array.isArray(manifest) ? manifest : null
            };
          }
        }
      }

      // Try direct files
      const items = await ghList(band);
      const files = items.filter(it => it.type === 'file' && EXT_RX.test(it.name)).map(it => it.name);
      if (files.length) {
        return { parts: band, list: files, manifest: null, bandData: null };
      }

      // Try subfolders
      const subs = items.filter(it => it.type === 'dir');
      for (const sub of subs) {
        const subParts = band.concat([sub.name]);
        const subManifest = await loadBandManifest(subParts);
        if (subManifest && (Array.isArray(subManifest) || subManifest.images)) {
          const images = Array.isArray(subManifest) ? subManifest : subManifest.images;
          if (images && images.length > 0) {
            const imageFiles = images.filter(n => EXT_RX.test(n));
            if (imageFiles.length > 0) {
              return {
                parts: subParts,
                list: imageFiles,
                manifest: subManifest,
                bandData: typeof subManifest === 'object' && !Array.isArray(subManifest) ? subManifest : null
              };
            }
          }
        }
      }
    } catch (error) {
      console.warn(`Failed to process ${bandName}:`, error);
    }
    return null;
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function titleFromFolder(name) {
    return decodeURIComponent(name).replace(/[-_]/g, ' ').replace(/\s+/g, ' ').trim();
  }

  // Main build function
  async function build() {
    const startTime = performance.now();
    
    try {
      loading.style.display = 'flex';
      grid.style.display = 'none';

      // Check if Universal Caption System is loaded with retry
      let ucsRetries = 0;
      while (!window.UniversalCaptionSystem && ucsRetries < 10) {
        console.log(`Waiting for Universal Caption System... (${ucsRetries + 1}/10)`);
        await new Promise(resolve => setTimeout(resolve, 500));
        ucsRetries++;
      }
      
      if (!window.UniversalCaptionSystem) {
        console.warn('Universal Caption System not available, using fallback mode');
        // Create a minimal fallback
        window.UniversalCaptionSystem = {
          getImageCaption: async (url, filename, manifest) => {
            // For fallback, prioritize band context over individual filename
            const cleanFilename = filename.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ');
            return {
              title: cleanFilename, // Individual photo title from filename
              caption: 'Live concert photography',
              date: null,
              source: 'fallback'
            };
          },
          formatDate: (date) => date ? new Date(date).getFullYear() : new Date().getFullYear(),
          getCacheSize: () => 0,
          version: 'fallback',
          name: 'Fallback Caption System'
        };
      }

      // Fetch band list
      const entries = await ghList(GH.base);
      const bands = entries.filter(it => it.type === 'dir').map(it => it.name);
      
      if (!bands.length) {
        showError('No concerts found.');
        return;
      }

      // Process bands in batches
      const shuffledBands = shuffle(bands);
      const pools = [];
      const batchSize = 6;
      
      for (let i = 0; i < shuffledBands.length; i += batchSize) {
        const batch = shuffledBands.slice(i, i + batchSize);
        const batchResults = await Promise.allSettled(
          batch.map(band => processBandAlbum(band))
        );
        
        batchResults.forEach((result, idx) => {
          if (result.status === 'fulfilled' && result.value) {
            const r = result.value;
            const band = batch[idx];
            const images = shuffle(r.list.slice());
            
            pools.push({
              dir: r.parts.join('/'),
              parts: r.parts,
              title: titleFromFolder(band),
              manifest: r.manifest,
              bandData: r.bandData,
              images,
              allImages: r.list.slice()
            });
          }
        });

        if (pools.length >= TARGET_PANES) break;
      }

      if (!pools.length) {
        showError('No concert images available.');
        return;
      }

      // Create cards with round-robin
      const slots = [];
      let progress = true;
      while (slots.length < TARGET_PANES && progress) {
        progress = false;
        for (const pool of pools) {
          if (slots.length >= TARGET_PANES) break;
          const fname = pool.images.shift();
          if (fname) {
            slots.push({
              dir: pool.dir,
              parts: pool.parts,
              title: pool.title,
              thumb: fname,
              allImages: pool.allImages,
              manifest: pool.manifest,
              bandData: pool.bandData
            });
            progress = true;
          }
        }
      }

      // Render cards
      const fragment = document.createDocumentFragment();
      const cards = [];

      // Process each slot with Universal Caption System
      for (let i = 0; i < slots.length; i++) {
        const slot = slots[i];
        const card = document.createElement('article');
        card.className = 'concert-card loading';
        card.tabIndex = 0;
        card.dataset.dir = slot.dir;

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        img.alt = `${slot.title} concert photo`;

        // Get caption data using Universal Caption System
        const imageUrl = rawUrl(slot.parts.concat([slot.thumb]));
        const captionData = await window.UniversalCaptionSystem.getImageCaption(
          imageUrl, 
          slot.thumb, 
          slot.manifest
        );

        // Create band metadata - prioritize band folder name over individual photo titles
        const bandMeta = slot.bandData || {};
        const dateLabel = captionData.date ? 
          window.UniversalCaptionSystem.formatDate(captionData.date) : 
          (bandMeta.date ? window.UniversalCaptionSystem.formatDate(bandMeta.date) : YEAR);

        // Use band folder name as primary title, with fallback to caption title
        const displayTitle = slot.title || captionData.title || 'Concert Photos';
        
        const info = document.createElement('div');
        info.className = 'concert-info';
        info.innerHTML = `
          <h3 class="concert-title">${displayTitle}</h3>
          <p class="concert-meta">Live ‚Ä¢ ${dateLabel}</p>
        `;

        card.appendChild(img);
        card.appendChild(info);
        fragment.appendChild(card);
        
        // Store caption data for lightbox
        card.captionData = captionData;
        card.bandData = bandMeta;
        cards.push({ card, slot, img });

        // Lightbox handler
        const openLightbox = () => openLB(card, slot.allImages);
        card.addEventListener('click', openLightbox);
        card.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openLightbox();
          }
        });
      }

      grid.appendChild(fragment);

      // Load images progressively
      cards.forEach(({ card, slot, img }, index) => {
        setTimeout(() => {
          loadCardImage({ card, slot, img });
        }, index * 100);
      });

      // Show results
      loading.style.display = 'none';
      grid.style.display = 'block';
      requestAnimationFrame(() => {
        grid.classList.add('loaded');
        animateCardsIn();
      });

      const loadTime = performance.now() - startTime;
      console.log(`Concert portfolio loaded in ${Math.round(loadTime)}ms`);
      console.log('‚ú® Universal Caption System:', window.UniversalCaptionSystem.name, 'v' + window.UniversalCaptionSystem.version);
      
      if (DEBUG_MODE) {
        setupPerformanceMonitoring();
        metrics.classList.add('visible');
        
        const rect = pf.getBoundingClientRect();
        const hasSpaceRight = window.innerWidth - rect.right > 220;
        metrics.classList.toggle('left', !hasSpaceRight);
      }

      setupDebugToggle();

    } catch (error) {
      console.error('Concert gallery failed:', error);
      showError('Error loading concerts. Please try again.');
    }
  }

  async function loadCardImage({ card, slot, img }) {
    try {
      const src = rawUrl(slot.parts.concat([slot.thumb]));
      await loadImageWithRetry(img, src, 3);
      card.classList.remove('loading');
      card.classList.add('loaded');
    } catch (error) {
      console.warn(`Failed to load image for ${slot.title}:`, error);
      card.classList.remove('loading');
      card.classList.add('error');
    }
  }

  async function loadImageWithRetry(img, src, maxRetries = 3) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      const tryLoad = () => {
        const tempImg = new Image();
        tempImg.onload = () => { img.src = src; resolve(); };
        tempImg.onerror = () => {
          attempts++;
          if (attempts >= maxRetries) {
            reject(new Error(`Failed to load after ${maxRetries} attempts`));
          } else {
            setTimeout(tryLoad, Math.pow(2, attempts) * 500);
          }
        };
        tempImg.src = src + `?retry=${attempts}`;
      };
      tryLoad();
    });
  }

  function animateCardsIn() {
    const cards = grid.querySelectorAll('.concert-card');
    cards.forEach((card, index) => {
      setTimeout(() => {
        card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        card.classList.add('loaded');
      }, index * 100);
    });
  }

  let metricsInterval = null;
  
  function setupPerformanceMonitoring() {
    // Clear any existing interval
    if (metricsInterval) {
      clearInterval(metricsInterval);
      metricsInterval = null;
    }
    
    const updateMetrics = () => {
      if (!DEBUG_MODE) return; // Safety check
      const cacheSize = window.UniversalCaptionSystem.getCacheSize();
      metrics.innerHTML = `
        <div>API: ${performanceMetrics.requests} reqs, ${performanceMetrics.cacheHits}/${performanceMetrics.cacheMisses} cache</div>
        <div>Avg: ${Math.round(performanceMetrics.avgResponseTime)}ms</div>
        <div>Errors: ${performanceMetrics.errors}</div>
        <div>UCS Cache: ${cacheSize} items</div>
      `;
    };
    
    metricsInterval = setInterval(updateMetrics, 2000);
    updateMetrics();
  }
  
  function stopPerformanceMonitoring() {
    if (metricsInterval) {
      clearInterval(metricsInterval);
      metricsInterval = null;
    }
  }

  function showError(message) {
    loading.innerHTML = `
      <div style="color: var(--accent); font-size: 18px; margin-bottom: 8px;">‚ö†Ô∏è</div>
      <div>${message}</div>
    `;
  }

  function setupDebugToggle() {
    if (!debugToggle) return;
    
    debugToggle.addEventListener('click', () => {
      DEBUG_MODE = !DEBUG_MODE;
      localStorage.setItem('concert-debug', DEBUG_MODE.toString());
      
      updateDebugButton();
      
      if (DEBUG_MODE) {
        setupPerformanceMonitoring();
        metrics.classList.add('visible');
        
        const rect = pf.getBoundingClientRect();
        const hasSpaceRight = window.innerWidth - rect.right > 220;
        metrics.classList.toggle('left', !hasSpaceRight);
      } else {
        stopPerformanceMonitoring();
        metrics.classList.remove('visible');
      }
    });
  }

  // Enhanced lightbox with Universal Caption System
  const lb = document.getElementById('concertLightbox');
  const lbDialog = lb.querySelector('.cl-dialog');
  const lbGallery = document.getElementById('clGallery');
  const lbTitle = document.getElementById('clLbTitle');
  const lbMeta = document.getElementById('clLbMeta');
  const lbDescription = document.getElementById('clLbDescription');
  const lbSource = document.getElementById('clLbSource');
  const lbClose = lb.querySelector('.cl-close');

  async function openLB(card, imageNames) {
    const parts = card.dataset.dir.split('/').filter(Boolean);
    const names = Array.isArray(imageNames) ? shuffle(imageNames) : [];
    
    // Use caption data from card - prioritize band folder name
    const captionData = card.captionData || {};
    const bandData = card.bandData || {};
    
    // Extract band name from directory path for title
    const bandFolderName = parts[parts.length - 1] || 'Concert';
    const bandName = bandFolderName.replace(/[-_]/g, ' ').replace(/\s+/g, ' ').trim();
    
    lbGallery.innerHTML = '<div class="cl-hint">Scroll ‚Üì</div>';
    lbTitle.textContent = bandName || captionData.title || 'Concert Photos';
    lbMeta.textContent = `Live ‚Ä¢ ${captionData.date ? 
      window.UniversalCaptionSystem.formatDate(captionData.date) : 
      (bandData.date ? window.UniversalCaptionSystem.formatDate(bandData.date) : YEAR)}`;
    
    // Show caption and source info
    lbDescription.textContent = captionData.caption || bandData.description || 'Live concert photography';
    lbSource.textContent = captionData.source ? `Caption source: ${captionData.source}` : '';
    
    lb.classList.add('is-open');
    lb.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    document.documentElement.classList.add('lb-open');
    setTimeout(() => lbDialog.focus(), 0);
    
    if (names.length > 0) {
      // Load images in batches
      const batchSize = 3;
      for (let i = 0; i < names.length; i += batchSize) {
        const batch = names.slice(i, i + batchSize);
        
        const batchPromises = batch.map(async (fname) => {
          const img = document.createElement('img');
          img.className = 'loading';
          img.loading = 'lazy';
          img.decoding = 'async';
          lbGallery.appendChild(img);
          
          try {
            const imgSrc = rawUrl(parts.concat([fname]));
            await loadImageWithRetry(img, imgSrc, 2);
            img.classList.remove('loading');
            img.classList.add('loaded');
          } catch (error) {
            console.warn(`Lightbox image failed: ${fname}`, error);
            img.alt = `Failed to load ${fname}`;
            img.classList.add('error');
          }
        });
        
        await Promise.allSettled(batchPromises);
        if (i + batchSize < names.length) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
    }
  }

  function closeLB() {
    lb.classList.remove('is-open');
    lb.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    document.documentElement.classList.remove('lb-open');
    lbGallery.innerHTML = '';
  }

  // Event handlers
  lbClose.addEventListener('click', closeLB);
  lb.addEventListener('click', e => { if (e.target === lb) closeLB(); });
  document.addEventListener('keydown', e => { 
    if (lb.classList.contains('is-open') && e.key === 'Escape') closeLB();
  });

  // Lightbox scroll controls
  (function() {
    const scroller = lbGallery;
    const hideHint = () => {
      const hint = scroller.querySelector('.cl-hint');
      if (hint) hint.classList.add('fade');
      scroller.removeEventListener('scroll', hideHint);
    };
    scroller.addEventListener('scroll', hideHint, { passive: true });
    
    document.addEventListener('keydown', (e) => {
      if (!lb.classList.contains('is-open')) return;
      const step = Math.round(window.innerHeight * 0.9);
      if (e.key === 'ArrowDown' || e.key === 'j') {
        e.preventDefault();
        scroller.scrollBy({ top: step, behavior: 'smooth' });
      }
      if (e.key === 'ArrowUp' || e.key === 'k') {
        e.preventDefault();
        scroller.scrollBy({ top: -step, behavior: 'smooth' });
      }
    });
  })();

  // Initialize
  build().catch(err => {
    console.error('Concert portfolio failed:', err);
    showError('Failed to initialize portfolio. Please refresh.');
  });

})();
</script>