<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concert Portfolio Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #111; 
            color: #fff; 
        }
        .test-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h1>üé∏ Concert Portfolio Widget Test</h1>
        <p><strong>Note:</strong> This is a local test file. The widget tries to fetch data from GitHub.</p>
        <p><strong>Open in browser:</strong> <code>file:///Users/mccal/McCals-Website/test-concert-widget.html</code></p>
        <p><strong>Check console</strong> (F12) for debug information and any errors.</p>
    </div>

    <!-- Concert Portfolio Widget v3.5 with Enhanced Debugging -->
    <style>
      :root { --fg:#f5f5f5; --bg:#0a0a0a; --line:#2a2a2a; --accent:#ff4d6d; }
      @media (prefers-color-scheme: light) { :root { --fg:#0a0a0a; --bg:#fff; --line:#e5e5e5; } }

      .concert-portfolio { max-width:1600px; margin:60px auto; padding:40px 20px; text-align:center; position:relative; }
      .concert-heading { font:800 34px/1.2 ui-sans-serif,system-ui; color:var(--fg); margin:0 0 18px }
      
      /* Loading states */
      .concert-loading {
        display: flex; align-items: center; justify-content: center; min-height: 200px;
        font: 600 16px/1.4 ui-sans-serif,system-ui; color: var(--fg); opacity: 0.7;
      }
      .concert-spinner {
        width: 20px; height: 20px; border: 2px solid var(--line); border-top: 2px solid var(--accent);
        border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Debug info panel - always visible for testing */
      .debug-info {
        background: rgba(0,0,0,0.85);
        color: #fff;
        padding: 12px 16px;
        border-radius: 6px;
        font: 600 11px/1.3 ui-monospace,monospace;
        max-width: 600px;
        margin: 20px auto;
        border: 1px solid var(--line);
        backdrop-filter: blur(10px);
      }

      /* Natural-height Masonry */
      .concert-grid { 
        column-width:320px; column-gap:20px; text-align:left; opacity:0; transition:opacity 0.5s ease;
      }
      .concert-grid.loaded { opacity: 1; }
      @media (max-width:1024px) { .concert-grid { column-width:280px } }
      @media (max-width:768px) { .concert-grid { column-width:240px } }
      @media (max-width:520px) { .concert-grid { column-width:100% } }

      .concert-card {
        position:relative; display:inline-block; width:100%; margin:0 0 20px;
        background:#111; border-radius:16px; overflow:hidden; cursor:pointer; break-inside:avoid;
        opacity:0; transform:translateY(20px); transition:all 0.3s ease;
      }
      .concert-card.loaded { opacity: 1; transform: translateY(0); }
      .concert-card img {
        display:block; width:100%; height:auto; object-fit:contain; border-radius:inherit;
        transition:transform .35s ease, filter .35s ease;
      }
      .concert-card:hover img { transform:scale(1.02); filter:contrast(1.08) saturate(1.08) }

      .concert-info {
        position:absolute; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:flex-end;
        padding:10px 14px; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.85)); color:#fff
      }
      .concert-title { margin:0; font:800 16px/1.2 ui-sans-serif,system-ui }
      .concert-meta { margin:2px 0 0; font:600 12px/1.2 ui-sans-serif,system-ui; color:#e5e5e5 }

      /* Loading states */
      .concert-card.loading::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        animation: shimmer 1.5s infinite;
      }
      @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
      
      .concert-card.error { background: #2a1a1a; border: 1px solid #4a2a2a; }
      .concert-card.error::after {
        content: '‚ö†Ô∏è'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 24px; opacity: 0.5;
      }

      /* Error display */
      .error-display {
        background: #2a1a1a;
        border: 1px solid #4a2a2a;
        border-radius: 8px;
        padding: 20px;
        margin: 20px;
        text-align: center;
      }
    </style>

    <div class="concert-portfolio" id="concertPf" data-panes="12">
      <h2 class="concert-heading">Concert Portfolio (Local Test)</h2>
      
      <div class="concert-loading" id="concertLoading">
        <div class="concert-spinner"></div>
        Loading concerts...
      </div>
      <div class="concert-grid" id="concertGrid"></div>
      
      <!-- Always-visible debug info for testing -->
      <div class="debug-info" id="debugInfo">
        <div style="margin-bottom: 8px; color: var(--accent); font-weight: 700;">üé∏ Concert Debug (Local Test)</div>
        <div>Status: <span id="debugStatus">Initializing...</span></div>
        <div>Load Time: <span id="debugLoadTime">--</span>ms</div>
        <div>Concerts: <span id="debugConcertCount">--</span></div>
        <div>Images: <span id="debugImageCount">--</span></div>
        <div>API Calls: <span id="debugApiCalls">--</span></div>
        <div>Manifest URL: <span id="debugManifestUrl">--</span></div>
        <div>Last Error: <span id="debugLastError">None</span></div>
      </div>
    </div>

    <script>
    // Debug toggle functionality
    let debugMetrics = {
      startTime: performance.now(),
      apiCalls: 0,
      concertCount: 0,
      imageCount: 0,
      lastError: 'None'
    };

    function updateDebugMetrics() {
      const loadTime = Math.round(performance.now() - debugMetrics.startTime);
      document.getElementById('debugLoadTime').textContent = loadTime;
      document.getElementById('debugConcertCount').textContent = debugMetrics.concertCount;
      document.getElementById('debugImageCount').textContent = debugMetrics.imageCount;
      document.getElementById('debugApiCalls').textContent = debugMetrics.apiCalls;
      document.getElementById('debugLastError').textContent = debugMetrics.lastError;
    }

    (function() {
      const pf = document.getElementById('concertPf');
      const grid = document.getElementById('concertGrid');
      const loading = document.getElementById('concertLoading');
      const debugStatus = document.getElementById('debugStatus');
      
      if (!grid) return;

      const TARGET_PANES = Math.max(1, parseInt(pf?.dataset?.panes || '12', 10) || 12);
      
      // Debug logging
      function logDebug(message, data = null) {
        console.log(`[Concert Debug] ${message}`, data || '');
        if (debugStatus) {
          debugStatus.textContent = message;
          updateDebugMetrics();
        }
      }

      // GitHub configuration with multiple fallbacks
      const GH = { owner:'McCal-Codes', repo:'McCals-Website', branch:'main' };
      const rawBase = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`;

      // Try multiple manifest URLs with cache-busting
      const manifestUrls = [
        rawBase + `images/Portfolios/Concert/concert-manifest.json?cb=${Date.now()}`,
        rawBase + `images/Portfolios/Concert/concert-manifest.json`,
        // Fallback to jsdelivr CDN
        `https://cdn.jsdelivr.net/gh/${GH.owner}/${GH.repo}@${GH.branch}/images/Portfolios/Concert/concert-manifest.json`
      ];

      document.getElementById('debugManifestUrl').textContent = manifestUrls[0];

      function rawUrl(parts) { 
        return rawBase + 'images/Portfolios/Concert/' + parts.map(encodeURIComponent).join('/'); 
      }

      // Load master manifest with multiple fallbacks
      async function loadMasterManifest() {
        debugMetrics.apiCalls++;
        
        for (let i = 0; i < manifestUrls.length; i++) {
          const manifestUrl = manifestUrls[i];
          logDebug(`Trying manifest URL ${i + 1}/${manifestUrls.length}...`);
          
          try {
            const response = await fetch(manifestUrl, {
              cache: 'no-store',
              headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const manifest = await response.json();
            logDebug(`Manifest loaded successfully from URL ${i + 1}`, `${manifest.bands?.length || 0} bands`);
            return manifest;
            
          } catch (error) {
            logDebug(`URL ${i + 1} failed: ${error.message}`);
            debugMetrics.lastError = error.message;
            updateDebugMetrics();
            
            if (i === manifestUrls.length - 1) {
              throw new Error(`All manifest URLs failed. Last error: ${error.message}`);
            }
            // Continue to next URL
          }
        }
      }

      function shuffle(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      // Main build function with enhanced error handling
      async function build() {
        const startTime = performance.now();
        
        try {
          loading.style.display = 'flex';
          grid.style.display = 'none';

          logDebug('Starting build process...');

          // Load master manifest with fallbacks
          const manifest = await loadMasterManifest();
          
          if (!manifest || !manifest.bands || manifest.bands.length === 0) {
            throw new Error('No concert data found in manifest or manifest is empty.');
          }

          logDebug(`Loaded ${manifest.bands.length} bands from manifest`);
          
          const pools = [];
          
          // Process bands from manifest
          for (const band of manifest.bands) {
            const images = shuffle(band.images.slice());
            pools.push({
              dir: band.folderPath,
              parts: band.folderPath.split('/'),
              title: band.bandName,
              dateDisplay: band.dateDisplay,
              images,
              allImages: band.images.slice()
            });
            logDebug(`Added pool for ${band.bandName}`, `${images.length} images, date: ${band.dateDisplay}`);
          }

          debugMetrics.concertCount = pools.length;
          logDebug(`Created ${pools.length} image pools`);

          if (!pools.length) {
            throw new Error('No concert images available from manifest.');
          }

          // Clear existing grid
          grid.innerHTML = '';

          // Create cards with round-robin
          const slots = [];
          let progress = true;
          while (slots.length < TARGET_PANES && progress) {
            progress = false;
            for (const pool of pools) {
              if (slots.length >= TARGET_PANES) break;
              const fname = pool.images.shift();
              if (fname) {
                slots.push({
                  dir: pool.dir,
                  parts: pool.parts,
                  title: pool.title,
                  dateDisplay: pool.dateDisplay,
                  thumb: fname,
                  allImages: pool.allImages
                });
                progress = true;
              }
            }
          }

          debugMetrics.imageCount = slots.length;
          logDebug(`Created ${slots.length} image slots`);

          // Render cards
          const fragment = document.createDocumentFragment();
          const cards = [];

          for (let i = 0; i < slots.length; i++) {
            const slot = slots[i];
            const card = document.createElement('article');
            card.className = 'concert-card loading';
            card.tabIndex = 0;
            card.dataset.dir = slot.dir;

            const img = document.createElement('img');
            img.loading = 'lazy';
            img.decoding = 'async';
            img.alt = `${slot.title} concert photo`;

            const info = document.createElement('div');
            info.className = 'concert-info';
            info.innerHTML = `
              <h3 class="concert-title">${slot.title}</h3>
              <p class="concert-meta">${slot.dateDisplay}</p>
            `;

            card.appendChild(img);
            card.appendChild(info);
            fragment.appendChild(card);
            
            cards.push({ card, slot, img });
          }

          grid.appendChild(fragment);

          // Load images progressively
          cards.forEach(({ card, slot, img }, index) => {
            setTimeout(() => {
              loadCardImage({ card, slot, img });
            }, index * 100);
          });

          // Show results
          loading.style.display = 'none';
          grid.style.display = 'block';
          requestAnimationFrame(() => {
            grid.classList.add('loaded');
            animateCardsIn();
          });

          const loadTime = performance.now() - startTime;
          logDebug(`Concert portfolio loaded successfully!`, `${Math.round(loadTime)}ms with ${debugMetrics.apiCalls} API call(s)`);

        } catch (error) {
          logDebug('Concert gallery failed', error.message);
          console.error('Concert gallery failed:', error);
          debugMetrics.lastError = error.message;
          updateDebugMetrics();
          showError(`Error loading concerts: ${error.message}`);
        }
      }

      async function loadCardImage({ card, slot, img }) {
        try {
          const src = rawUrl(slot.parts.concat([slot.thumb]));
          logDebug(`Loading image: ${src}`);
          await loadImageWithRetry(img, src, 2);
          card.classList.remove('loading');
          card.classList.add('loaded');
        } catch (error) {
          console.warn(`Failed to load image for ${slot.title}:`, error);
          card.classList.remove('loading');
          card.classList.add('error');
        }
      }

      async function loadImageWithRetry(img, src, maxRetries = 2) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const tryLoad = () => {
            const tempImg = new Image();
            tempImg.onload = () => { 
              img.src = src; 
              logDebug(`Image loaded: ${src}`);
              resolve(); 
            };
            tempImg.onerror = () => {
              attempts++;
              logDebug(`Image load attempt ${attempts} failed: ${src}`);
              if (attempts >= maxRetries) {
                reject(new Error(`Failed to load after ${maxRetries} attempts`));
              } else {
                setTimeout(tryLoad, Math.pow(2, attempts) * 500);
              }
            };
            tempImg.src = src + `?retry=${attempts}`;
          };
          tryLoad();
        });
      }

      function animateCardsIn() {
        const cards = grid.querySelectorAll('.concert-card');
        cards.forEach((card, index) => {
          setTimeout(() => {
            card.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            card.classList.add('loaded');
          }, index * 100);
        });
      }

      function showError(message) {
        loading.innerHTML = `
          <div class="error-display">
            <div style="color: var(--accent); font-size: 18px; margin-bottom: 8px;">‚ö†Ô∏è</div>
            <div style="margin-bottom: 12px;">${message}</div>
            <div>Check the browser console (F12) for more details.</div>
            <div style="margin-top: 12px;">
              <button onclick="window.location.reload()" style="background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                Retry
              </button>
            </div>
          </div>
        `;
        logDebug('ERROR', message);
      }

      // Initialize
      logDebug('Initializing concert portfolio...');
      build().catch(error => {
        console.error('Failed to initialize concert portfolio:', error);
        showError('Failed to load concert portfolio. Check console for details.');
      });

    })();
    </script>
</body>
</html>